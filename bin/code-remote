#!/bin/bash

# script analysed with https://www.shellcheck.net

readonly try_languages=( "python" "go" "php" "node" "java" "rust" "dotnet" "cpp" "sqlserver" )
readonly USAGE="
USAGE:
       code-remote FOLDER|GIT-URL
       code-remote --try|-t LANGUAGE

       LANGUAGE: the following languages are available in a try dev-container: 
                  ${try_languages[@]} 

"

# make script exit early on errors
set -eE  # BEST: traps error in subshell with right linenumber in code
       # -e  Exit immediately if a command exits with a non-zero status.
       # -E  If set, the ERR trap is inherited by shell functions.
       # We set this also for every function, because when in subshells
       # set -eE is not inherited. By setting it in every function we
       # sure it is enabled again. (set -u and set -x is always inherited in subshells)
       # e.g. when calling a function in command substition
       #   manifest_digest=$(get_manifest_digest_for_a_tag_for_a_specific_os_arch "$image" "$tag")
       #                    `-> runs in subshell
set -u # script ends with signal EXIT when unset variable is used
       # also use "local" and "readonly" keywords to limit scope of declared variables
set -o nounset;set -u

# check required commands
if ! command -v code &> /dev/null
then
   echo "ERROR: 'code' commandline command could not be found"
   echo "       Install using Visual Studio Code with \"Install 'code' command in PATH\" command."
   exit 1
fi

function find_in_array() {
  local searchword="$1"
  shift
  for item in "$@"
  do 
      [[ "$item" == "$searchword" ]] && return 0 
  done
  return 1
}

function code-remote-try {
    set -eE 
    local lang="$1"

    if ! find_in_array "$lang" "${try_languages[@]}" 
    then
       echo "ERROR: The language '$lang' is not available in a try dev-container." 
       echo "       Only the following languages are supported: ${try_languages[@]}"
       return 1 
    fi
    local url="https://github.com/microsoft/vscode-remote-try-$lang"
    echo "opening dev container from $url"
    code-remote "$url"
}    
    
function code-remote {   
   set -eE 
   local hostfolder
   local devcontfile
  
   # parse options
   while [[ "$#" -gt 0 && "$1" == -* ]]
   do
      if [[ "$1" == "--help" || "$1" == "-h" ]]
      then
          echo "$USAGE"
          exit 0
      fi
      if [[ "$1" == "--try" || "$1" == "-t" ]]
      then 
          [[ "$#" -lt 2 ]] &&  echo "$USAGE" && exit 1
          lang="$2" 
          code-remote-try "$lang"          
          exit 0
      fi
   done 

   # we must have a single argument
   if [[  "$#" -ne "1" ]]
   then
      echo "$USAGE"
      exit 0
   fi 

   # get hostfolder 
   hostfolder="$1"
   if [[ "$hostfolder" == git@* || "$hostfolder" == http* ]] ;
   then
      local vscodegitdir="/tmp/.vscode-remote-git-clones"
      local git_url="$hostfolder"
      # local hex_encoded_url
      # hex_encoded_url=$(printf "%s" "$git_url" | xxd -p)
      # hex_encoded_url=${hex_encoded_url//[[:space:]]/}
      # hostfolder="$vscodegitdir/$hex_encoded_url"

      # http(s):// or git@ only says indirectly something about authentication method  
      # but what comes after it is the real location of the repository
      # strip git@ prefix
      hostfolder=${hostfolder#git@}
      # strip http:// or https:// prefix
      hostfolder=${hostfolder#http://}
      hostfolder=${hostfolder#https://}
      # escape some characters with _
      #hostfolder=$(echo "$hostfolder" | tr ' $%^&*()[]+#!~`?><,;=\\/' '_')
      
      hostfolder="$vscodegitdir/$hostfolder"
      
      #note git automatically creates all folders in hostfolder which do not exist when cloning to a hostfolder
      if [[ ! -d "$hostfolder" ]]
      then    
          git clone "$git_url" "$hostfolder"
      fi  
      
   else
       if [[ ! -d "$hostfolder" ]]
       then 
           echo "ERROR: folder '$hostfolder' does not exist"
           exit 1
       fi    
       hostfolder=$(realpath "$hostfolder") 
   fi

   # get devcontainer.json file
   #
   if [[ -e "${hostfolder}/.devcontainer/devcontainer.json"  ]]
   then
       devcontfile="${hostfolder}/.devcontainer/devcontainer.json"
   else  
     if [[ -e "${hostfolder}/.devcontainer.json"  ]]
     then 
         devcontfile="${hostfolder}/.devcontainer.json"
     else
         echo "ERROR: cannot find a devcontainer.json file" 1>&2
         return 1
     fi    
   fi 

   # get workspacefolder from devcontainer.json
   local workspacefolder
   # first check whether some fields are specified in devcontainer.json
   local contains_workspaceFolder="false"
   local contains_image="false"
   local contains_dockerFile="false"
   local contains_dockerComposeFile="false"
   grep -E '^\s*"workspaceFolder' "$devcontfile" 2>/dev/null >/dev/null && contains_workspaceFolder="true"
   grep -E '^\s*"image' "$devcontfile" 2>/dev/null >/dev/null && contains_image="true"
   grep -E '^\s*"dockerFile' "$devcontfile" 2>/dev/null >/dev/null && contains_dockerFile="true"
   grep -E '^\s*"dockerComposeFile' "$devcontfile" 2>/dev/null >/dev/null && contains_dockerComposeFile="true"

   if [[ "$contains_dockerComposeFile" == "true" ]]
   then
       echo "using docker compose to start a composition of containers"
       if [[ "$contains_workspaceFolder" == "true" ]]
       then
          workspacefolder=$(grep -E  '^\s*"workspaceFolder' "$devcontfile" | sed 's/.*:\s*"//' |sed 's/"\s*,\s*$//')
          echo "explicit set workspace folder in devcontainer to: $workspacefolder"
       else    
          echo "no workspace folder for devcontainer specified"
          echo "so set workspace folder in devcontainer to default: /"
       fi
   else  
       if  [[ "$contains_image" == "true" || "$contains_dockerFile" == "true"  ]]
       then
           echo "using a single container using an image or dockerfile"
           local basename
           local bindfolder
           basename=$(basename "$hostfolder")
           bindfolder="/workspaces/$basename"
           echo "by default local folder '$hostfolder' binded to folder '$bindfolder' in container"
           if [[ "$contains_workspaceFolder" == "true" ]]
           then
              workspacefolder=$(grep -E  '^\s*"workspaceFolder' "$devcontfile" | sed 's/.*:\s*"//' |sed 's/"\s*,\s*$//')
              echo "explicit set workspace folder in devcontainer to: $workspacefolder"
           else    
              workspacefolder=$bindfolder
              echo "no workspace folder in devcontainer config  specified"
              echo "so set workspace folder in devcontainer config by default to binded folder: $bindfolder "
           fi   
       else 
           echo "ERROR: devcontainer config '$devcontfile'" 'is missing one of "image", "dockerFile" or "dockerComposeFile" properties.'
           exit 1
       fi    
   fi    

   # using hostfolder and workspacefolder open the devcontainer    
   local hexencodedhostfolder
   hexencodedhostfolder=$(printf "%s" "$hostfolder" | xxd -p)
   hexencodedhostfolder=${hexencodedhostfolder//[[:space:]]/}
   code --folder-uri "vscode-remote://dev-container+$hexencodedhostfolder/$workspacefolder" 
   
   # from https://code.visualstudio.com/docs/remote/troubleshooting#_connect-to-a-remote-host-from-the-terminal
   # https://code.visualstudio.com/docs/remote/troubleshooting#_connect-to-a-remote-host-from-the-terminal
   # https://github.com/microsoft/vscode-remote-release/issues/2133#issuecomment-618328138
   # https://github.com/microsoft/vscode-remote-release/issues/2133#issuecomment-860863636
   # https://github.com/microsoft/vscode-remote-release/issues/2133#issuecomment-1212180962
   #  
   # we can use 
   #     code --folder-uri "vscode-remote://dev-container+$hexencodedhostfolder/$containerfolder"
   # or
   #     code --remote  dev-container+$hexencodedhostfolder $containerfolder
   #
   #
   # background info from # https://code.visualstudio.com/remote/advancedcontainers/change-default-source-mount:
   #
   #  If you add the image or dockerFile properties to devcontainer.json, VS Code will automatically "bind" mount your current workspace folder into the container.
   #   cases:
   #    -  https://github.com/microsoft/vscode-remote-try-python -> has "image": ..  => so mounts folder in /workspaces in container
   #    -  /Users/harcok/Documents/help/tools/web/cms_and_wiki_and_websitegenerators/pmwiki/pmwikiconf
   #         or 
   #       git@gitlab.science.ru.nl:harcok/pmwikiconf.git
   #        has ""dockerComposeFile: .. => but not "dockerFile" nor "image"  =>  so does not mount folder in /workspaces in container
   #           => in this case we must supply a workspaceFolder, otherwise vscode does not know which folder to open
   #              note: if not given, then vscode ask's for it in a dialog
   #  note: 
   #     special case in vscode itself: 
   #        Dev Containers: Clone repository in (named) container volume 
   #     then  
   #        vscode clones git in a (named) container volume and then 
   #        mounts this volume in /volumes and set it as the workspacefolder in vscode
   #        vscode ignores the fields WorkspaceFolder and workspaceMount in devcontainer.json 
}

code-remote "$@"
